---

# package configuration
_basic_system_packages:
  default:
    - gnupg2
    - curl
  Debian:
    - software-properties-common
    - procps
  RedHat:
    - procps-ng

basic_system_packages: "{{ _basic_system_packages['default'] + _basic_system_packages[ansible_os_family] }}"

_mysql_package_list:
  Debian:
    mariadb:
      - mariadb-server
      - mariadb-client
      - mariadb-common
    mysql:
      - mysql-server
  RedHat:
    mariadb:
      - MariaDB-server
      - MariaDB-client
      - MariaDB-shared
      - MariaDB-common
    mysql:
      - mysql-community-server

mysql_package_list: "{% if mysql_install_settings.use_mariadb | bool %}{{ _mysql_package_list[ansible_os_family]['mariadb'] }}{% else %}{{ _mysql_package_list[ansible_os_family]['mysql'] }}{% endif %}"

mysql_server_type: "{% if mysql_install_settings.use_mariadb | bool %}mariadb{% else %}mysql{% endif %}"

_mysql_conf:
  Debian:
    mariadb:
      file_path: "/etc/mysql/my.cnf"
      include_dir: "/etc/mysql/conf.d"
    mysql:
      file_path: "/etc//mysql/my.cnf"
      include_dir: "/etc/mysql/conf.d"
  RedHat:
    mysql:
      file_path: "/etc/my.cnf"
      include_dir: "/etc/my.cnf.d"
    mariadb:
      file_path: "/etc/my.cnf"
      include_dir: "/etc/my.cnf.d"

mysql_conf: "{{ _mysql_conf[ansible_os_family][mysql_server_type] }}"

# repo configuration
_mysql_repo_file_mapping:
  Debian:
    mariadb:
      - { source: "sources.list.d/mariadb/MariaDB.list.j2", dest: "/etc/apt/sources.list.d/MariaDB.list" }
    mysql:
      - { source: "sources.list.d/mysql/mysql.list.j2", dest: "/etc/apt/sources.list.d/mysql.list" }
  RedHat:
    mariadb:
      - { source: "yum.repos.d/mariadb/MariaDB.repo.j2", dest: "/etc/yum.repos.d/MariaDB.repo" }
    mysql:
      - { source: "yum.repos.d/mysql/mysql-community.repo.j2", dest: "/etc/yum.repos.d/mysql-community.repo" }

mysql_repo_file_info: "{% if mysql_install_settings.use_mariadb | bool %}{{ _mysql_repo_file_mapping[ansible_os_family]['mariadb'] }}{% else %}{{ _mysql_repo_file_mapping[ansible_os_family]['mysql'] }}{% endif %}"

_rpm_gpg_key_info:
  mariadb:
    - { url: "https://yum.mariadb.org/RPM-GPG-KEY-MariaDB", dest: "/tmp/RPM-GPG-KEY-MariaDB" }
  mysql:
    - { url: "https://repo.mysql.com/RPM-GPG-KEY-mysql", dest: "/tmp/RPM-GPG-KEY-mysql"}

rpm_gpg_key_info: "{% if mysql_install_settings.use_mariadb | bool %}{{ _rpm_gpg_key_info['mariadb'] }}{% else %}{{ _rpm_gpg_key_info['mysql'] }}{% endif %}"

# https://dev.mysql.com/doc/refman/8.0/en/checking-gpg-signature.html
_apt_gpg_key_info:
  mariadb:
    - { server: "keyserver.ubuntu.com", fingerprint: "177F4010FE56CA3336300305F1656F24C74CD1D8" }
  mysql:
    - { server: "keys.gnupg.net", fingerprint: "A4A9406876FCBD3C456770C88C718D3B5072E1F5" }

apt_gpg_key_info: "{% if mysql_install_settings.use_mariadb | bool %}{{ _apt_gpg_key_info['mariadb'] }}{% else %}{{ _apt_gpg_key_info['mysql'] }}{% endif %}"

# service configuration
_mysql_service_daemon:
  Debian:
    mariadb:
      name: mariadb
    mysql:
      name: mysql
  RedHat:
    mariadb:
      name: mariadb
    mysql:
      name: mysqld

mysql_service_daemon: "{% if mysql_install_settings.use_mariadb | bool %}{{ _mysql_service_daemon[ansible_os_family]['mariadb']['name'] }}{% else %}{{ _mysql_service_daemon[ansible_os_family]['mysql']['name'] }}{% endif %}"

_mysql_my_cnf_template:
  mariadb:
    source: "mysql/server/mariadb.my.cnf.j2"
  mysql:
    source: "mysql/server/mysql.my.cnf.j2"

mysql_my_cnf_template: "{{ _mysql_my_cnf_template[mysql_server_type]['source'] }}"

_mysql_dir_list:
  - "/var/run/mysqld"
mysql_dir_list: "{% if mysql_conf_settings.log_error | length > 0 %}{{ _mysql_dir_list + [''+ mysql_conf_settings.log_error | dirname] }}{% else %}{{ _mysql_dir_list + ['/var/log/mysql'] }}{% endif %}"

distro_short_name: "{% if 'CentOS' in ansible_distribution %}el{% else %}fc{% endif %}"

config_templates:
  - {src: "sysctl.d/99-sysctl.conf.j2", dest: "/etc/sysctl.d/99-sysctl.conf", mode: "0644"}
  - {src: "limits.d/99-limits.conf.j2", dest: "/etc/security/limits.d/99-limits.conf", mode: "0644"}
